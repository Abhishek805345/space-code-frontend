<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Room</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* =======================
   RESET & BASE
======================= */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: Inter, Arial, Helvetica, sans-serif;
}

body {
  height: 100vh;
  background: linear-gradient(135deg, #eef2ff, #f8fafc);
  display: flex;
  flex-direction: column;
}

/* =======================
   NAVBAR
======================= */
nav {
  height: 60px;
  background: #0f172a;
  color: #ffffff;
  padding: 0 28px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: 0 4px 14px rgba(0,0,0,0.15);
}

nav .logo {
  font-size: 18px;
  font-weight: 700;
}
/* =======================
   NAVBAR HOME BUTTON
======================= */
nav a {
  text-decoration: none;
}

nav a button {
  background: linear-gradient(135deg, #6366f1, #4f46e5);
  color: #ffffff;
  border: none;
  padding: 8px 18px;
  border-radius: 999px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 6px 14px rgba(79, 70, 229, 0.45);
  transition: all 0.25s ease;
  display: flex;
  align-items: center;
  gap: 6px;
}

/* Hover */
nav a button:hover {
  transform: translateY(-1px);
  box-shadow: 0 10px 22px rgba(79, 70, 229, 0.6);
}

/* Active */
nav a button:active {
  transform: translateY(0);
  box-shadow: 0 4px 10px rgba(79, 70, 229, 0.4);
}

/* Focus (accessibility) */
nav a button:focus-visible {
  outline: 2px solid #a5b4fc;
  outline-offset: 2px;
}


/* =======================
   MAIN LAYOUT
======================= */
.container {
  flex: 1;
  display: flex;
  gap: 16px;
  padding: 16px;
  overflow: hidden;
}

/* =======================
   CODE SECTION
======================= */
.code-section {
  flex: 2;
  background: #ffffff;
  border-radius: 14px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  box-shadow: 0 10px 30px rgba(0,0,0,0.08);
  position:relative;
}

.code-header {
  padding: 14px 18px;
  background: #f8fafc;
  border-bottom: 1px solid #e5e7eb;
  font-weight: 600;
}

.code-editor {
  flex: 1;
  padding: 16px;
  background: #f9fafb;
}

.code-editor textarea {
  width: 100%;
  height: 100%;
  resize: none;
  border-radius: 12px;
  padding: 16px;
  font-family: "Fira Code", monospace;
  font-size: 14px;
  background: #0f172a;
  color: #e5e7eb;
  border: none;
  outline: none;
}

/* =======================
   CODE ACTION BAR
======================= */
.code-actions {
  padding: 12px 16px;
  background: #f8fafc;
  border-top: 1px solid #e5e7eb;
  display: flex;
  justify-content: space-between;
}

.code-actions button {
  padding: 10px 18px;
  background: linear-gradient(135deg, #6366f1, #4f46e5);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 6px 16px rgba(79,70,229,0.35);
  transition: all 0.25s ease;
}

.code-actions button:hover {
  transform: translateY(-1px);
  box-shadow: 0 10px 22px rgba(79,70,229,0.45);
}

.code-actions button:active {
  transform: translateY(0);
  box-shadow: 0 4px 10px rgba(79,70,229,0.35);
}

/* =======================
   CHAT SECTION
======================= */
.chat-section {
  flex: 1;
  background: #ffffff;
  border-radius: 14px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  box-shadow: 0 10px 30px rgba(0,0,0,0.08);
}

.chat-header {
  padding: 14px 18px;
  background: #f8fafc;
  border-bottom: 1px solid #e5e7eb;
  font-weight: 600;
}

.chat-messages {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
  background: #f3f4f6;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.chat-message {
  max-width: 72%;
  padding: 10px 14px;
  border-radius: 12px;
  background: #e5e7eb;
  font-size: 14px;
}

.chat-message.me {
  margin-left: auto;
  background: #dbeafe;
}

.chat-input {
  padding: 12px;
  display: flex;
  gap: 10px;
  border-top: 1px solid #e5e7eb;
}

.chat-input input {
  flex: 1;
  padding: 12px 14px;
  border-radius: 10px;
  border: 1px solid #d1d5db;
}

/* ===== CHAT ACTION BUTTON LAYOUT ===== */
.chat-section > button {
  all: unset;
}

/* Container alignment */
.chat-section {
  position: relative;
}

/* SEND BUTTON â€” large, left */
.chat-section > button:nth-of-type(1) {
  margin: 8px 0 12px 12px;
  width: calc(100% - 90px); /* leaves space for mic */
  padding: 14px 0;
  background: linear-gradient(135deg, #6366f1, #4f46e5);
  color: white;
  font-size: 15px;
  font-weight: 600;
  text-align: center;
  border-radius: 999px;
  cursor: pointer;
  box-shadow: 0 8px 20px rgba(79,70,229,0.35);
  transition: all 0.25s ease;
}

.chat-section > button:nth-of-type(1):hover {
  transform: translateY(-1px);
  box-shadow: 0 12px 26px rgba(79,70,229,0.45);
}

.chat-section > button:nth-of-type(1):active {
  transform: translateY(0);
  box-shadow: 0 6px 14px rgba(79,70,229,0.35);
}

/* MIC BUTTON â€” small, right */
.chat-section > button:nth-of-type(2) {
  position: absolute;
  right: 14px;
  bottom: 18px;
  width: 42px;
  height: 42px;
  border-radius: 50%;
  background: #0f172a;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 8px 20px rgba(0,0,0,0.25);
  transition: all 0.25s ease;
}

/* Mic icon size */
.chat-section > button:nth-of-type(2) h1 {
  font-size: 22px;
  line-height: 1;
}

/* Mic hover */
.chat-section > button:nth-of-type(2):hover {
  transform: scale(1.08);
  background: #1e293b;
}

/* Mic active */
.chat-section > button:nth-of-type(2):active {
  transform: scale(0.95);
}


.chat-section button:hover {
  background: #475569;
}
/* Wrapper: username + message + time */
#chat-messages > div {
  display: flex;
  flex-direction: column;
  gap: 4px;
  max-width: 75%;
  margin-bottom: 10px;
}

/* Username */
.username {
  font-size: 12px;
  font-weight: 600;
  color: #475569;
  margin-left: 6px;
}

/* Message bubble */
.chat-message {
  padding: 10px 14px;
  border-radius: 12px;
  background: #e5e7eb;
  font-size: 14px;
  line-height: 1.4;
  color: #0f172a;
  word-break: break-word;
}

/* Time */
#chat-messages > div > div:last-child {
  font-size: 11px;
  color: #64748b;
  margin-left: 10px;
  opacity: 0.8;
}

/* OPTIONAL: right side for own messages */
#chat-messages > div.me {
  margin-left: auto;
  align-items: flex-end;
}

#chat-messages > div.me .chat-message {
  background: #dbeafe;
}

#chat-messages > div.me .username {
  color: #1d4ed8;
}
/* ===== Overlay ===== */
.overlay {
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.55);
  backdrop-filter: blur(6px);

  display: none;              /* hidden on page load */
  z-index: 1000;
}

.overlay.active {
  display: block;
}

/* ===== Popup ===== */
.popup {
  width: 420px;
  background: #ffffff;
  border-radius: 14px;
  padding: 24px;
  box-shadow: 0 30px 80px rgba(0, 0, 0, 0.35);

  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(1);

  animation: popupScale 0.25s ease;
}

/* ===== Animation (IMPORTANT FIX) ===== */
@keyframes popupScale {
  from {
    transform: translate(-50%, -50%) scale(0.95);
    opacity: 0;
  }
  to {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
  }
}

/* ===== Close Button ===== */
.close-btn {
  position: absolute;
  top: 14px;
  right: 14px;
  border: none;
  background: transparent;
  font-size: 18px;
  cursor: pointer;
  color: #475569;
}

.close-btn:hover {
  color: #ef4444;
}

/* ===== Content ===== */
.popup h2 {
  margin: 0;
  font-size: 20px;
  color: #0f172a;
}

.subtitle {
  margin: 6px 0 18px;
  font-size: 14px;
  color: #64748b;
}

/* ===== Form ===== */
.popup form {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.popup label {
  font-size: 14px;
  color: #334155;
}

.popup input {
  padding: 10px 12px;
  border-radius: 8px;
  border: 1px solid #cbd5f5;
  font-size: 14px;
  outline: none;
}

.popup input:focus {
  border-color: #6366f1;
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
}

/* ===== Actions ===== */
.actions {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 20px;
}

.actions button {
  padding: 8px 16px;
  border-radius: 8px;
  font-size: 14px;
  cursor: pointer;
  border: none;
}

.actions .cancel {
  background: #f1f5f9;
  color: #334155;
}

.actions .cancel:hover {
  background: #e2e8f0;
}

.actions .primary {
  background: linear-gradient(135deg, #6366f1, #4f46e5);
  color: white;
}

.actions .primary:hover {
  opacity: 0.9;
}



</style>
</head>

<body>

<!-- NAVBAR -->
<nav>
  <div class="logo">Collab Room</div>
  <a href="/after-home/<%=userdata._id%>"><button>Home</button></a>
  <a href="/get-room/<%= userdata._id %>">Code Rooms</a>
  <a href="/get-interview-room/<%= userdata._id %>">Interview Rooms</a>
</nav>

<!-- MAIN -->
<div class="container">
  
  <!-- CODE AREA -->
  <div class="code-section">
    <div class="code-header">Code Editor</div>

    <div class="code-editor">
      <textarea id="code" placeholder="Write your code here...">
        <%if (data.code&& data.code.length>0){%>
          <%=data.code%>
          <%}%>       
      </textarea>
    </div>
<!-- Overlay -->
<div class="overlay" id="overlay">
  <div class="popup">
    <button class="close-btn" onclick="closePopup()">âœ•</button>

    <h2>Create New File</h2>
    <p class="subtitle">Give your file a meaningful name</p>

   
      <label for="filename">File name</label>
      <input 
        type="text" 
        id="filename" 
        placeholder="example.txt" 
        name="filename"
        required
      >
      
      <input type="hidden" value="<%=userdata.username%>" id="saver"> 
      <div class="actions">
        <button type="button" class="cancel" onclick="closePopup()">Cancel</button>
        <button onclick="savefile(),closePopup()" class="primary">Create</button>
      </div>
   
  </div>
</div>



    <div class="code-actions">
      <button onclick="openPopup()">Create a code file</button>
     <button onclick="submitcode()">â–¶ Submit Code</button>
    </div>
  </div>

  <!-- CHAT AREA -->
  <div class="chat-section">
    <div class="chat-header">Chat</div>
    <audio id="remoteAudio" autoplay></audio>
    <div id="chat-messages" class="chat-messages"></div>



    <div class="chat-input">
      <input type="text" id="chat" placeholder="Type your message..." />
      <input type="hidden" id="roomid" value="<%=data._id%>" />
      <input type="hidden" id="hostid" value="<%=data.hostid%>" />
      <input type="hidden" id="codeid" value="<%=data._id%>code" />
      <input type="hidden" id="username" value="<%=userdata.username%>"/>
    </div>
    <button onclick="send()">Send</button>
    <button onclick="audio()"><h1>ðŸŽ¤</h1></button>
  </div>


</div>

<script src="https://space-code-backend.onrender.com/socket.io/socket.io.js"></script>


<script>
  let pc=null;
  let localstream=null;    //pc for the call itself and localstream for microphone
const socket = io("https://space-code-backend.onrender.com");
//inserting roomid
const roomid=document.getElementById('roomid').value;


socket.emit("join-room", document.getElementById("roomid").value);
socket.emit("join-coderoom", document.getElementById("codeid").value);

socket.on("receive-message", ({message,time,username}) => {
  const chat = document.getElementById("chat-messages");
   const text=document.createElement('div');    //to wrapp all username chat and time of message
  const msg = document.createElement("div");    //message
  const user=document.createElement('div');   //username
  const tme=document.createElement('div');   //time
  user.className="username";
  msg.className = "chat-message";
  user.textContent=`${username}`;
  msg.textContent = `${message}`;
  tme.textContent=`${time}`;
  text.appendChild(user);
  text.appendChild(msg);
  text.appendChild(tme);
  chat.appendChild(text);
  console.log('username is this',username);
});

socket.on("receive-code", ({ message }) => {
  document.getElementById("code").value = message;
});

function send() {
  socket.emit("send-message", {
    roomid: document.getElementById("roomid").value,
    message: document.getElementById("chat").value,
    hostid: document.getElementById("hostid").value,
    username:document.getElementById('username').value
  });
}

function submitcode() {
  socket.emit("send-code", {
    codeid: document.getElementById("codeid").value,
    message: document.getElementById("code").value,
    roomid: document.getElementById("roomid").value       //to save the code to db with roomid
  });
}

// audio fxn for creating the peer connection
async function audio(){
createpc();
//seting localstream 
localstream=await navigator.mediaDevices.getUserMedia({audio:true});
//now we will add tracks to pc
localstream.getTracks().forEach(tracks=>{
  pc.addTrack(tracks,localstream);
})
//on track event 
pc.ontrack=(event)=>{
  console.log('remote event received');
  const remoteAudio=document.getElementById('remoteAudio');
  remoteAudio.srcObject=event.streams[0];
}
//icecandidate sharing 
pc.onicecandidate=(event)=>{
  if (event.candidate){
    socket.emit('send-candidate',{roomid,candidate:event.candidate});
  }
}

//creating offer and sending them
if (pc){
  const offer=await pc.createOffer();
  await pc.setLocalDescription(offer);
  socket.emit('send-offer',({roomid,offer}));
}



}

function createpc(){
  pc=new RTCPeerConnection({
    iceServers:[
      {
        urls:[
          "stun:stun.l.google.com:19302" ,
          "stun:stun.l.google.com:5349",
        ]
      }
    ]
  })
} //createpc fxn ended

//handling 'receive-offer'
socket.on('receive-offer',async ({offer})=>{
  //create localstream for user B to send to user A
  if (!pc) createpc();
  //creating localstream 
  localstream=await navigator.mediaDevices.getUserMedia({audio:true});
  //adding tracks to pc
  localstream.getTracks().forEach(track=>{
    pc.addTrack(track,localstream);
  });

  await pc.setRemoteDescription(new RTCSessionDescription(offer));
  const answer=await pc.createAnswer();
  await pc.setLocalDescription(answer);
  console.log(answer);
  socket.emit('send-answer',{roomid,answer});
})
socket.on('receive-answer',async ({answer})=>{
  await pc.setRemoteDescription(new RTCSessionDescription(answer));
})
socket.on('receive-candidate',async ({candidate})=>{
  await pc.addIceCandidate(new RTCIceCandidate(candidate));
})

//extra 
  function closePopup() {
    document.getElementById("overlay").style.display = "none";
  }

  function openPopup() {
    document.getElementById("overlay").style.display = "flex";
  }

   //saving the code to database without reloading
  async function savefile(){
    const data={
      roomid:roomid,
      filename:document.getElementById('filename').value,
      saver:document.getElementById('saver').value,
      code:document.getElementById('code').value
    }
    //rest api to connect with backend
  const responce=await fetch('http://localhost:3001/api/save/file',{
    method:"post",
    credentials:'include',
    headers:{
      "Content-Type":"application/json"
    },
    body:JSON.stringify(data)
    });
  const result=await responce.json();
  console.log(result);
  }
</script> 

</body>
</html>
