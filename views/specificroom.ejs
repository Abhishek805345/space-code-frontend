<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Room</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* =======================
   RESET & BASE
======================= */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: Inter, Arial, Helvetica, sans-serif;
}

body {
  height: 100vh;
  background: linear-gradient(135deg, #eef2ff, #f8fafc);
  display: flex;
  flex-direction: column;
}

/* =======================
   NAVBAR
======================= */
nav {
  height: 60px;
  background: #0f172a;
  color: #ffffff;
  padding: 0 28px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: 0 4px 14px rgba(0,0,0,0.15);
}

nav .logo {
  font-size: 18px;
  font-weight: 700;
}

/* =======================
   MAIN LAYOUT
======================= */
.container {
  flex: 1;
  display: flex;
  gap: 16px;
  padding: 16px;
  overflow: hidden;
}

/* =======================
   CODE SECTION
======================= */
.code-section {
  flex: 2;
  background: #ffffff;
  border-radius: 14px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  box-shadow: 0 10px 30px rgba(0,0,0,0.08);
}

.code-header {
  padding: 14px 18px;
  background: #f8fafc;
  border-bottom: 1px solid #e5e7eb;
  font-weight: 600;
}

.code-editor {
  flex: 1;
  padding: 16px;
  background: #f9fafb;
}

.code-editor textarea {
  width: 100%;
  height: 100%;
  resize: none;
  border-radius: 12px;
  padding: 16px;
  font-family: "Fira Code", monospace;
  font-size: 14px;
  background: #0f172a;
  color: #e5e7eb;
  border: none;
  outline: none;
}

/* =======================
   CODE ACTION BAR
======================= */
.code-actions {
  padding: 12px 16px;
  background: #f8fafc;
  border-top: 1px solid #e5e7eb;
  display: flex;
  justify-content: flex-end;
}

.code-actions button {
  padding: 10px 18px;
  background: linear-gradient(135deg, #6366f1, #4f46e5);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 6px 16px rgba(79,70,229,0.35);
  transition: all 0.25s ease;
}

.code-actions button:hover {
  transform: translateY(-1px);
  box-shadow: 0 10px 22px rgba(79,70,229,0.45);
}

.code-actions button:active {
  transform: translateY(0);
  box-shadow: 0 4px 10px rgba(79,70,229,0.35);
}

/* =======================
   CHAT SECTION
======================= */
.chat-section {
  flex: 1;
  background: #ffffff;
  border-radius: 14px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  box-shadow: 0 10px 30px rgba(0,0,0,0.08);
}

.chat-header {
  padding: 14px 18px;
  background: #f8fafc;
  border-bottom: 1px solid #e5e7eb;
  font-weight: 600;
}

.chat-messages {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
  background: #f3f4f6;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.chat-message {
  max-width: 72%;
  padding: 10px 14px;
  border-radius: 12px;
  background: #e5e7eb;
  font-size: 14px;
}

.chat-message.me {
  margin-left: auto;
  background: #dbeafe;
}

.chat-input {
  padding: 12px;
  display: flex;
  gap: 10px;
  border-top: 1px solid #e5e7eb;
}

.chat-input input {
  flex: 1;
  padding: 12px 14px;
  border-radius: 10px;
  border: 1px solid #d1d5db;
}

/* ===== CHAT ACTION BUTTON LAYOUT ===== */
.chat-section > button {
  all: unset;
}

/* Container alignment */
.chat-section {
  position: relative;
}

/* SEND BUTTON â€” large, left */
.chat-section > button:nth-of-type(1) {
  margin: 8px 0 12px 12px;
  width: calc(100% - 90px); /* leaves space for mic */
  padding: 14px 0;
  background: linear-gradient(135deg, #6366f1, #4f46e5);
  color: white;
  font-size: 15px;
  font-weight: 600;
  text-align: center;
  border-radius: 999px;
  cursor: pointer;
  box-shadow: 0 8px 20px rgba(79,70,229,0.35);
  transition: all 0.25s ease;
}

.chat-section > button:nth-of-type(1):hover {
  transform: translateY(-1px);
  box-shadow: 0 12px 26px rgba(79,70,229,0.45);
}

.chat-section > button:nth-of-type(1):active {
  transform: translateY(0);
  box-shadow: 0 6px 14px rgba(79,70,229,0.35);
}

/* MIC BUTTON â€” small, right */
.chat-section > button:nth-of-type(2) {
  position: absolute;
  right: 14px;
  bottom: 18px;
  width: 42px;
  height: 42px;
  border-radius: 50%;
  background: #0f172a;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 8px 20px rgba(0,0,0,0.25);
  transition: all 0.25s ease;
}

/* Mic icon size */
.chat-section > button:nth-of-type(2) h1 {
  font-size: 22px;
  line-height: 1;
}

/* Mic hover */
.chat-section > button:nth-of-type(2):hover {
  transform: scale(1.08);
  background: #1e293b;
}

/* Mic active */
.chat-section > button:nth-of-type(2):active {
  transform: scale(0.95);
}


.chat-section button:hover {
  background: #475569;
}
/* Wrapper: username + message + time */
#chat-messages > div {
  display: flex;
  flex-direction: column;
  gap: 4px;
  max-width: 75%;
  margin-bottom: 10px;
}

/* Username */
.username {
  font-size: 12px;
  font-weight: 600;
  color: #475569;
  margin-left: 6px;
}

/* Message bubble */
.chat-message {
  padding: 10px 14px;
  border-radius: 12px;
  background: #e5e7eb;
  font-size: 14px;
  line-height: 1.4;
  color: #0f172a;
  word-break: break-word;
}

/* Time */
#chat-messages > div > div:last-child {
  font-size: 11px;
  color: #64748b;
  margin-left: 10px;
  opacity: 0.8;
}

/* OPTIONAL: right side for own messages */
#chat-messages > div.me {
  margin-left: auto;
  align-items: flex-end;
}

#chat-messages > div.me .chat-message {
  background: #dbeafe;
}

#chat-messages > div.me .username {
  color: #1d4ed8;
}


</style>
</head>

<body>

<!-- NAVBAR -->
<nav>
  <div class="logo">Collab Room</div>
</nav>

<!-- MAIN -->
<div class="container">
  
  <!-- CODE AREA -->
  <div class="code-section">
    <div class="code-header">Code Editor</div>

    <div class="code-editor">
      <textarea id="code" placeholder="Write your code here...">
        <%if (data.code&& data.code.length>0){%>
          <%=data.code%>
          <%}%>       
      </textarea>
    </div>

    <div class="code-actions">
     <button onclick="submitcode()">â–¶ Submit Code</button>
    </div>
  </div>

  <!-- CHAT AREA -->
  <div class="chat-section">
    <div class="chat-header">Chat</div>
  <video id="localVideo" autoplay muted playsinline width="250"></video>
  <video id="remoteVideo" autoplay playsinline width="250"></video>
    <div id="chat-messages" class="chat-messages"></div>



    <div class="chat-input">
      <input type="text" id="chat" placeholder="Type your message..." />
      <input type="hidden" id="roomid" value="<%=data._id%>" />
      <input type="hidden" id="hostid" value="<%=data.hostid%>" />
      <input type="hidden" id="codeid" value="<%=data._id%>code" />
      <input type="hidden" id="username" value="<%=userdata.username%>"/>
    </div>
    <button onclick="send()">Send</button>
    <button onclick="audio()"><h1>ðŸŽ¤</h1></button>
  </div>


</div>

<script src="https://space-code-backend.onrender.com/socket.io/socket.io.js"></script>


<script>
  let pc=null;
  let localstream=null;    //pc for the call itself and localstream for microphone
const socket = io("https://space-code-backend.onrender.com");
//inserting roomid
const roomid=document.getElementById('roomid').value;


socket.emit("join-room", document.getElementById("roomid").value);
socket.emit("join-coderoom", document.getElementById("codeid").value);

socket.on("receive-message", ({message,time,username}) => {
  const chat = document.getElementById("chat-messages");
   const text=document.createElement('div');    //to wrapp all username chat and time of message
  const msg = document.createElement("div");    //message
  const user=document.createElement('div');   //username
  const tme=document.createElement('div');   //time
  user.className="username";
  msg.className = "chat-message";
  user.textContent=`${username}`;
  msg.textContent = `${message}`;
  tme.textContent=`${time}`;
  text.appendChild(user);
  text.appendChild(msg);
  text.appendChild(tme);
  chat.appendChild(text);
  console.log('username is this',username);
});

socket.on("receive-code", ({ message }) => {
  document.getElementById("code").value = message;
});

function send() {
  socket.emit("send-message", {
    roomid: document.getElementById("roomid").value,
    message: document.getElementById("chat").value,
    hostid: document.getElementById("hostid").value,
    username:document.getElementById('username').value
  });
}

function submitcode() {
  socket.emit("send-code", {
    codeid: document.getElementById("codeid").value,
    message: document.getElementById("code").value,
    roomid: document.getElementById("roomid").value       //to save the code to db with roomid
  });
}

// audio fxn for creating the peer connection
async function audio(){
createpc();
//seting localstream 
localstream=await navigator.mediaDevices.getUserMedia({audio:true,video:true});
//now we will add tracks to pc
localstream.getTracks().forEach(tracks=>{
  pc.addTrack(tracks,localstream);
})
document.getElementById('localVideo').srcObject=localstream;
//on track event 
pc.ontrack=(event)=>{
  console.log('remote event received');
  const remoteVideo=document.getElementById('remoteVideo');
  remoteVideo.srcObject=event.streams[0];
}
//icecandidate sharing 
pc.onicecandidate=(event)=>{
  if (event.candidate){
    socket.emit('send-candidate',{roomid,candidate:event.candidate});
  }
}

//creating offer and sending them
if (pc){
  const offer=await pc.createOffer();
  await pc.setLocalDescription(offer);
  socket.emit('send-offer',({roomid,offer}));
}



}

function createpc(){
  pc=new RTCPeerConnection({
    iceServers:[
      {
        urls:[
          "stun:stun.l.google.com:19302" ,
          "stun:stun.l.google.com:5349",
        ]
      }
    ]
  })
} //createpc fxn ended

//handling 'receive-offer'
socket.on('receive-offer',async ({offer})=>{
  //create localstream for user B to send to user A
  if (!pc) createpc();
  //creating localstream 
  localstream=await navigator.mediaDevices.getUserMedia({audio:true,video:true});
  document.getElementById("localVideo").srcObject=localstream;
  //adding tracks to pc
  localstream.getTracks().forEach(track=>{
    pc.addTrack(track,localstream);
  });

  await pc.setRemoteDescription(new RTCSessionDescription(offer));
  const answer=await pc.createAnswer();
  await pc.setLocalDescription(answer);
  console.log(answer);
  socket.emit('send-answer',{roomid,answer});
})
socket.on('receive-answer',async ({answer})=>{
  await pc.setRemoteDescription(new RTCSessionDescription(answer));
})
socket.on('receive-candidate',async ({candidate})=>{
  await pc.addIceCandidate(new RTCIceCandidate(candidate));
})


</script>

</body>
</html>
